CREATE PROCEDURE "EACHUSER"."BAT_RPCLEARFEETAB" ()
	LANGUAGE SQL
BEGIN
	Declare sPhase VARCHAR(10);
    Declare sBizDATE VARCHAR(10);
    Declare sPREVDATE VARCHAR(10);
    --SET sPhase = 0;
	SET sBizDATE = (SELECT THISDATE FROM EACHUSER.EACHSYSSTATUSTAB);
    SET sPhase = (SELECT	(case when ClearingPhase='01' then '02' else '01' end) FROM	EACHUSER.EACHSYSSTATUSTAB);    
    SET sPREVDATE = (SELECT PREVDATE FROM EACHUSER.EACHSYSSTATUSTAB);

    --20150523 edit by PU
    --Call EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPCLEARFEETAB', 'P' ,'');
    CALL EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPCLEARFEETAB', 'P');

Delete EACHUSER.RPCLEARFEETAB Where BizDATE=sBizDATE and CLEARINGPHASE =sPhase ;
--本期的結算資料收費檔
INSERT INTO EACHUSER.RPCLEARFEETAB(BIZDATE, CLEARINGPHASE,YYYYMM, TXN_ID, BUSINESS_TYPE_ID, BRBK_ID, BGBK_ID, SENDERID, OP_TYPE, CNT, AMT, RVSCNT, RVSAMT) 
select 
       BIZDATE
        ,CLEARINGPHASE
        ,substr(BIZDATE,1,6) YYYYMM
        ,TXN_ID
        ,(select BUSINESS_TYPE_ID from EACHUSER.TXN_CODE where TXN_ID=X.TXN_ID) BUSINESS_TYPE_ID
        ,BRBK_ID
         ,EACHUSER.GETBKHEADID(BRBK_ID) BGBK_ID
         ,SENDERID
        ,OP_TYPE 
        ,CNT
        , AMT
        , RVSCNT
        , RVSAMT
from (
     --扣款行手續費 (+應收; -應付)  
    (select   coalesce(C.BIZDATE ,D.BIZDATE) BIZDATE
        ,coalesce(C.CLEARINGPHASE ,D.CLEARINGPHASE) CLEARINGPHASE
        ,coalesce(C.TXN_ID ,D.TXN_ID) TXN_ID
        ,coalesce(C.BRBK_ID ,D.BRBK_ID) BRBK_ID
         ,coalesce(C.SENDERID ,D.SENDERID) SENDERID
        ,coalesce(C.OP_TYPE ,D.OP_TYPE) OP_TYPE 
        ,coalesce(CNT,0) CNT
        ,coalesce(AMT,0) AMT
        ,coalesce(RVSCNT,0) RVSCNT
        ,coalesce(RVSAMT,0)  RVSAMT
from 
(
SELECT
       BIZDATE
       ,CLEARINGPHASE
        ,TXID TXN_ID
        ,OUTBANKID BRBK_ID
         ,SENDERID
         ,'O' OP_TYPE
        ,Count(*)  CNT
        ,SUM (NEWOUTFEE) AMT
    FROM
        EACHUSER.VW_ONBLOCKTAB 
    Where NEWRESULT != 'R'  and SENDERSTATUS != '1' and CLEARINGPHASE=sPhase and BIZDATE=sBizDATE
    Group by     BIZDATE , CLEARINGPHASE ,  TXID ,OUTBANKID ,SENDERID
    ) C
    FULL OUTER JOIN
    (SELECT
        NEWBIZDATE BIZDATE
        ,NEWCLRPHASE CLEARINGPHASE
        ,TXID TXN_ID
        ,OUTBANKID BRBK_ID
         ,SENDERID
          ,'O' OP_TYPE
        ,Count(*)  RVSCNT
        ,SUM (NEWOUTFEE)  RVSAMT
    FROM
        EACHUSER.VW_ONPENDING_EC
    Where NEWBIZDATE=sBizDATE and NEWCLRPHASE=sPhase 
    Group by  NEWBIZDATE , NEWCLRPHASE , TXID , OUTBANKID ,SENDERID
    ) D on D.BIZDATE=C.BIZDATE and D.CLEARINGPHASE=C.CLEARINGPHASE and D.TXN_ID=C.TXN_ID and D.BRBK_ID=C.BRBK_ID and D.SENDERID=C.SENDERID
)
Union All
     --入帳行手續費 (+應收; -應付)
   (select coalesce(A.BIZDATE ,B.BIZDATE) BIZDATE
        ,coalesce(A.CLEARINGPHASE ,B.CLEARINGPHASE) CLEARINGPHASE
        ,coalesce(A.TXN_ID ,B.TXN_ID) TXN_ID
        ,coalesce(A.BRBK_ID ,B.BRBK_ID) BRBK_ID
         ,coalesce(A.SENDERID ,B.SENDERID) SENDERID
        ,coalesce(A.OP_TYPE ,B.OP_TYPE) OP_TYPE 
        ,coalesce(CNT,0) CNT
        ,coalesce(AMT,0) AMT
        ,coalesce(RVSCNT,0) RVSCNT
        ,coalesce(RVSAMT,0)  RVSAMT
    from 
    (SELECT
        BIZDATE
       ,CLEARINGPHASE
        ,TXID TXN_ID
        ,INBANKID BRBK_ID
        ,SENDERID
        ,'I' OP_TYPE
        ,Count(*) CNT
        ,SUM (NEWINFEE) AMT
    FROM
        EACHUSER.VW_ONBLOCKTAB 
    Where NEWRESULT != 'R' and SENDERSTATUS != '1' and CLEARINGPHASE=sPhase and BIZDATE=sBizDATE
    Group by     BIZDATE , CLEARINGPHASE , TXID , INBANKID,SENDERID
    ) A
    FULL OUTER JOIN
    (SELECT
        NEWBIZDATE BIZDATE
        ,NEWCLRPHASE CLEARINGPHASE
        ,TXID TXN_ID
        ,INBANKID BRBK_ID
        ,SENDERID
  ,'I' OP_TYPE
        ,Count(*) RVSCNT
        ,SUM (NEWINFEE) RVSAMT
    FROM
        EACHUSER.VW_ONPENDING_EC
    Where NEWBIZDATE=sBizDATE and NEWCLRPHASE=sPhase
    Group by     NEWBIZDATE , NEWCLRPHASE , TXID , INBANKID,SENDERID
    ) B on B.BIZDATE=A.BIZDATE and B.CLEARINGPHASE=A.CLEARINGPHASE and B.TXN_ID=A.TXN_ID and B.BRBK_ID=A.BRBK_ID and B.SENDERID=A.SENDERID
)
Union ALL
     --發動行手續費及?正(+應收; -應付)
   (select coalesce(A.BIZDATE ,B.BIZDATE) BIZDATE
        ,coalesce(A.CLEARINGPHASE ,B.CLEARINGPHASE) CLEARINGPHASE
        ,coalesce(A.TXN_ID ,B.TXN_ID) TXN_ID
        ,coalesce(A.BRBK_ID ,B.BRBK_ID) BRBK_ID
         ,coalesce(A.SENDERID ,B.SENDERID) SENDERID
        ,coalesce(A.OP_TYPE ,B.OP_TYPE) OP_TYPE 
        ,coalesce(CNT,0) CNT
        ,coalesce(AMT,0) AMT
        ,coalesce(RVSCNT,0) RVSCNT
        ,coalesce(RVSAMT,0)  RVSAMT
    from 
    (SELECT
        BIZDATE
       ,CLEARINGPHASE
        ,TXID TXN_ID
        ,SENDERBANKID BRBK_ID
        ,SENDERID
        ,'S' OP_TYPE
        ,Count(*) CNT
        ,SUM (NEWSENDERFEE) AMT
    FROM
        EACHUSER.VW_ONBLOCKTAB 
    Where NEWRESULT != 'R'  and SENDERSTATUS != '1' and CLEARINGPHASE=sPhase and BIZDATE=sBizDATE
    Group by     BIZDATE , CLEARINGPHASE , TXID , SENDERBANKID,SENDERID ) A
    FULL OUTER JOIN
    (SELECT
        NEWBIZDATE BIZDATE
        ,NEWCLRPHASE CLEARINGPHASE
        ,TXID TXN_ID
        ,SENDERBANKID BRBK_ID
        ,SENDERID
  ,'S' OP_TYPE
        ,Count(*) RVSCNT
        ,SUM (NEWSENDERFEE) RVSAMT
    FROM
        EACHUSER.VW_ONPENDING_EC
    Where NEWBIZDATE=sBizDATE and NEWCLRPHASE=sPhase 
    Group by     NEWBIZDATE , NEWCLRPHASE , TXID , SENDERBANKID,SENDERID ) B on B.BIZDATE=A.BIZDATE and B.CLEARINGPHASE=A.CLEARINGPHASE and B.TXN_ID=A.TXN_ID and B.BRBK_ID=A.BRBK_ID and B.SENDERID=A.SENDERID
 )
 )  X Where  not  (CNT =0 And  AMT =0 And RVSCNT =0 And RVSAMT =0 )
;
--補齊欄位
UPDATE RPCLEARFEETAB AS A SET
BRBK_NAME = (SELECT BRBK_NAME FROM EACHUSER.BANK_BRANCH WHERE BRBK_ID = A.BRBK_ID),
BGBK_NAME = (SELECT BGBK_NAME FROM EACHUSER.BANK_GROUP WHERE BGBK_ID = A.BGBK_ID),
OPBK_ID = (SELECT OPBK_ID FROM EACHUSER.BANK_GROUP WHERE BGBK_ID = A.BGBK_ID),
OPBK_NAME = (SELECT OP.BGBK_NAME FROM EACHUSER.BANK_GROUP BG LEFT JOIN EACHUSER.BANK_GROUP OP ON BG.OPBK_ID = OP.BGBK_ID WHERE BG.BGBK_ID = A.BGBK_ID),
TXN_NAME = (SELECT TXN_NAME FROM EACHUSER.TXN_CODE WHERE TXN_ID = A.TXN_ID),
COMPANY_ABBR_NAME = (
    SELECT COALESCE(COMPANY_ABBR_NAME,'')
    FROM (
        SELECT COMPANY_ID, TXN_ID, SND_BRBK_ID, COMPANY_ABBR_NAME 
        FROM EACHUSER.SC_COMPANY_PROFILE
        UNION
        SELECT COMPANY_ID, TXN_ID, SND_BRBK_ID, COMPANY_ABBR_NAME 
        FROM EACHUSER.SD_COMPANY_PROFILE
    )
    WHERE COMPANY_ID = A.SENDERID AND TXN_ID = A.TXN_ID AND SND_BRBK_ID = A.BRBK_ID
),
BUSINESS_TYPE_NAME = (SELECT BUSINESS_TYPE_NAME FROM EACHUSER.BUSINESS_TYPE WHERE BUSINESS_TYPE_ID = A.BUSINESS_TYPE_ID)
WHERE A.CLEARINGPHASE = sPhase AND A.BIZDATE = sBizDATE;
commit;
    --20150523 edit by PU
    --Call EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPCLEARFEETAB', 'S', '' );
    Call EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPCLEARFEETAB', 'S');
END