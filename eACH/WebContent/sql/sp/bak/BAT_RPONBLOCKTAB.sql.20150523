CREATE PROCEDURE "EACHUSER"."BAT_RPONBLOCKTAB" ()
	LANGUAGE SQL
BEGIN
	Declare sPhase VARCHAR(10);
    Declare sBizDATE VARCHAR(10);
    Declare sPREVDATE VARCHAR(10);
    Declare OnBlock_CNT VARCHAR(10);
    Declare OnPending_CNT VARCHAR(10);
    --SET sPhase = 0;
	SET sBizDATE = (SELECT THISDATE FROM EACHUSER.EACHSYSSTATUSTAB);
    SET sPhase = (SELECT	(case when ClearingPhase='01' then '02' else '01' end) FROM	EACHUSER.EACHSYSSTATUSTAB);   
    SET sPREVDATE = (SELECT PREVDATE FROM EACHUSER.EACHSYSSTATUSTAB);

Call EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPONBLOCKTAB', 'P' , '' );
Delete EACHUSER.RPONBLOCKTAB Where CLEARINGPHASE =sPhase and BizDATE=sBizDATE ;
---Processing ONBLOCKTAB 本期的交易資料
INSERT INTO EACHUSER.RPONBLOCKTAB( NEWRESULT,  TXDATE, STAN, PCODE, SENDERBANK, RECEIVERBANK, TXDT, SENDERSTATUS, RECEIVERSTATUS, TIMEOUTCODE, CONRESULTCODE, ACCTCODE, CLEARINGCODE, PENDINGCODE, SENDERCLEARING, INCLEARING, OUTCLEARING, SENDERACQUIRE, INACQUIRE, OUTACQUIRE, SENDERHEAD, INHEAD, OUTHEAD, SENDERFEE, INFEE, OUTFEE, EACHFEE, REFUNDDEADLINE, SENDERID, RECEIVERID, TXID, TXAMT, FEE, SENDERBANKID, INBANKID, OUTBANKID, BIZDATE, EACHDT, CLEARINGPHASE, INACCTNO, OUTACCTNO, INID, OUTID, ACCTBAL, AVAILBAL, CHECKTYPE, MERCHANTID, ORDERNO, TRMLID, TRMLCHECK, TRMLMCC, BANKRSPMSG, RRN, RESULTSTATUS, RC1, RC2, RC3, RC4, RC5, RC6, UPDATEDT, CONMEMO,COMPANY_ABBR, TXBIZDATE, TXCLEARINGPHASE, GARBAGEDATA) 
SELECT
RESULTSTATUS NEWRESULT ,    --原始交易的狀態不變
	TXDATE,
	STAN,
	PCODE,
	SENDERBANK,
	RECEIVERBANK,
	--timestamp(substr(TXDT,1,4) || '-' || substr(TXDT,5,2) || '-' || substr(TXDT,7,2) || '-' || substr(TXDT,9,2)|| '.' || substr(TXDT,11,2) || '.' || substr(TXDT,13,2) ) TXDT, 
NEWTXDT,
	SENDERSTATUS,
	RECEIVERSTATUS,
	TIMEOUTCODE,
	CONRESULTCODE,
	ACCTCODE,
	CLEARINGCODE,
	PENDINGCODE,
	SENDERCLEARING,
	INCLEARING,
	OUTCLEARING,
	SENDERACQUIRE,
	INACQUIRE,
	OUTACQUIRE,
	SENDERHEAD,
	INHEAD,
	OUTHEAD,
NEWSENDERFEE,
NEWINFEE,
NEWOUTFEE,
NEWEACHFEE,
	REFUNDDEADLINE,
	SENDERID,
	RECEIVERID,
	TXID,
NEWTXAMT,
NEWFEE,
	SENDERBANKID,
	INBANKID,
	OUTBANKID,
	BIZDATE,
	EACHDT,
	CLEARINGPHASE,
	INACCTNO,
	OUTACCTNO,
	INID,
	OUTID,
	ACCTBAL,
	AVAILBAL,
	CHECKTYPE,
	MERCHANTID,
	ORDERNO,
	TRMLID,
	TRMLCHECK,
	TRMLMCC,
	BANKRSPMSG,
	RRN,
	RESULTSTATUS,
	RC1,
	RC2,
	RC3,
	RC4,
	RC5,
	RC6, 
    UPDATEDT,	
    CONMEMO,
    EACHUSER.GETCOMPANY_ABBR(SENDERID) COMPANY_ABBR,
    TXBIZDATE,
    TXCLEARINGPHASE, 
    GARBAGEDATA
FROM
	EACHUSER.VW_ONBLOCKTAB
Where COALESCE(GARBAGEDATA,'') <> '*'  and CLEARINGPHASE =sPhase and BIZDATE =sBizDATE 
;
commit;
SET OnBlock_CNT=(SELECT char(count(*)) From EACHUSER.RPONBLOCKTAB Where CLEARINGPHASE =sPhase and BIZDATE =sBizDATE ) ;
Call EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPONBLOCKTAB', 'S' ,'總筆數:' || OnBlock_CNT );

-- Processing ONPENDINGTAB
Call EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPONPENDINGTAB', 'P' , '' );
Delete EACHUSER.RPONPENDINGTAB Where OCLEARINGPHASE =sPhase and OBIZDATE =sBizDATE;
INSERT INTO EACHUSER.RPONPENDINGTAB( RESP, OTXDATE, OSTAN, PCODE, CLEARINGCODE, OBIZDATE, OCLEARINGPHASE, BIZDATE, CLEARINGPHASE, RESULTCODE, SENDERBANK, SENDERCLEARING, INCLEARING, OUTCLEARING, SENDERACQUIRE, INACQUIRE, OUTACQUIRE, SENDERHEAD, INHEAD, OUTHEAD, SENDERFEE, INFEE, OUTFEE, EACHFEE, TXAMT, SENDERBANKID, OUTBANKID, INBANKID, OUTACCT, INACCT, ACHFLAG, TXOBIZDATE, TXOCLEARINGPHASE,	TXBIZDATE,	TXCLEARINGPHASE, CDATE) 
SELECT
   EACHUSER.GETRESPDESC(oTxDate,oStan) RESP
  -- , a.*
    ,OTXDATE, OSTAN, PCODE, CLEARINGCODE, OBIZDATE, OCLEARINGPHASE, BIZDATE, CLEARINGPHASE, RESULTCODE, SENDERBANK, SENDERCLEARING, INCLEARING, OUTCLEARING, SENDERACQUIRE, INACQUIRE, OUTACQUIRE, SENDERHEAD, INHEAD, OUTHEAD, SENDERFEE, INFEE, OUTFEE, EACHFEE, TXAMT, SENDERBANKID, OUTBANKID, INBANKID, OUTACCT, INACCT, ACHFLAG, TXOBIZDATE, TXOCLEARINGPHASE,	TXBIZDATE,	TXCLEARINGPHASE, CURRENT TIMESTAMP
FROM
	EACHUSER.ONPENDINGTAB a Where  OCLEARINGPHASE =sPhase and OBIZDATE =sBizDATE
;
commit;

Delete EACHUSER.RPONPENDINGTAB Where OCLEARINGPHASE =sPhase and OBIZDATE =sPREVDATE;
INSERT INTO EACHUSER.RPONPENDINGTAB( RESP, OTXDATE, OSTAN, PCODE, CLEARINGCODE, OBIZDATE, OCLEARINGPHASE, BIZDATE, CLEARINGPHASE, RESULTCODE, SENDERBANK, SENDERCLEARING, INCLEARING, OUTCLEARING, SENDERACQUIRE, INACQUIRE, OUTACQUIRE, SENDERHEAD, INHEAD, OUTHEAD, SENDERFEE, INFEE, OUTFEE, EACHFEE, TXAMT, SENDERBANKID, OUTBANKID, INBANKID, OUTACCT, INACCT, ACHFLAG, TXOBIZDATE, TXOCLEARINGPHASE,	TXBIZDATE,	TXCLEARINGPHASE, CDATE ) 
SELECT
   EACHUSER.GETRESPDESC(oTxDate,oStan) RESP
  -- , a.*
  ,OTXDATE, OSTAN, PCODE, CLEARINGCODE, OBIZDATE, OCLEARINGPHASE, BIZDATE, CLEARINGPHASE, RESULTCODE, SENDERBANK, SENDERCLEARING, INCLEARING, OUTCLEARING, SENDERACQUIRE, INACQUIRE, OUTACQUIRE, SENDERHEAD, INHEAD, OUTHEAD, SENDERFEE, INFEE, OUTFEE, EACHFEE, TXAMT, SENDERBANKID, OUTBANKID, INBANKID, OUTACCT, INACCT, ACHFLAG, TXOBIZDATE, TXOCLEARINGPHASE,	TXBIZDATE,	TXCLEARINGPHASE, CURRENT TIMESTAMP 
FROM
	EACHUSER.ONPENDINGTAB a Where  OCLEARINGPHASE =sPhase and OBIZDATE =sPREVDATE
;
commit;
SET OnPending_CNT=(SELECT char(count(*)) From EACHUSER.RPONPENDINGTAB Where OCLEARINGPHASE =sPhase and OBIZDATE =sBizDATE ) ;
Call EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPONPENDINGTAB', 'S', '總筆數：' || OnPending_CNT );
END