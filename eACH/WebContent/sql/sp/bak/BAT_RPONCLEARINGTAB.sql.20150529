CREATE PROCEDURE "EACHUSER"."BAT_RPONCLEARINGTAB" ()
	LANGUAGE SQL
BEGIN
	Declare sPhase VARCHAR(10);
    Declare sBizDATE VARCHAR(10);
    Declare sPREVDATE VARCHAR(10);
    Declare sTOTAL_RECVCNT VARCHAR(10);
    Declare sTOTAL_RECVAMT VARCHAR(16);
    Declare sTOTAL_PAYCNT VARCHAR(10); 
    Declare sTOTAL_PAYAMT VARCHAR(16);
    Declare sTOTAL_RVSRECVCNT VARCHAR(10);
    Declare sTOTAL_RVSRECVAMT VARCHAR(16);
    Declare sTOTAL_RVSPAYCNT VARCHAR(10);
    Declare sTOTAL_RVSPAYAMT VARCHAR(16);
    Declare sNote VARCHAR(300);
    --SET sPhase = 0;
	SET sBizDATE = (SELECT THISDATE FROM EACHUSER.EACHSYSSTATUSTAB);
    SET sPhase = (SELECT	(case when ClearingPhase='01' then '02' else '01' end) FROM	EACHUSER.EACHSYSSTATUSTAB);    
    SET sPREVDATE = (SELECT PREVDATE FROM EACHUSER.EACHSYSSTATUSTAB);

    --20150523 edit by PU
    --Call EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPONCLEARINGTAB', 'P', '' );
    CALL EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPONCLEARINGTAB', 'P');

Delete EACHUSER.RPONCLEARINGTAB Where BizDATE=sBizDATE and CLEARINGPHASE =sPhase ;
--本期的交易資料結算檔
INSERT INTO EACHUSER.RPONCLEARINGTAB(BIZDATE, CLEARINGPHASE, PCODE, BUSINESS_TYPE_ID, BRBK_ID, BGBK_ID, RECVCNT, RECVAMT, PAYCNT, PAYAMT, RVSRECVCNT, RVSRECVAMT, RVSPAYCNT, RVSPAYAMT, BRBK_NAME, BGBK_NAME, OPBK_ID, OPBK_NAME, EACH_TXN_NAME, BUSINESS_TYPE_NAME) 
select 
        coalesce(X.BIZDATE ,Y.BIZDATE) BIZDATE
        ,coalesce(X.CLEARINGPHASE ,Y.CLEARINGPHASE) CLEARINGPHASE
        ,coalesce(X.PCODE ,Y.PCODE) PCODE
        ,(select BUSINESS_TYPE_ID from EACHUSER.EACH_TXN_CODE where EACH_TXN_ID=coalesce(X.PCODE ,Y.PCODE)) BUSINESS_TYPE_ID
        ,coalesce(X.BRBK_ID ,Y.BRBK_ID) BRBK_ID
        ,EACHUSER.GETBKHEADID(coalesce(X.BRBK_ID ,Y.BRBK_ID)) BGBK_ID
        ,coalesce(X.RECVCNT,0) RECVCNT
        ,coalesce(X.RECVAMT,0) RECVAMT
        ,coalesce(Y.PAYCNT,0) PAYCNT
        ,coalesce(Y.PAYAMT,0) PAYAMT
        ,coalesce(X.RVSRECVCNT,0) RVSRECVCNT
        ,coalesce(X.RVSRECVAMT,0) RVSRECVAMT
        ,coalesce(Y.RVSPAYCNT,0) RVSPAYCNT
        ,coalesce(Y.RVSPAYAMT,0) RVSPAYAMT
        ,(SELECT BRBK_NAME FROM EACHUSER.BANK_BRANCH WHERE BRBK_ID = coalesce(X.BRBK_ID ,Y.BRBK_ID)) AS BRBK_NAME
        ,SUBSTR(EACHUSER.GETBKHEAD(coalesce(X.BRBK_ID ,Y.BRBK_ID)),9) AS BGBK_NAME
        ,(SELECT OPBK_ID FROM EACHUSER.BANK_GROUP WHERE BGBK_ID = EACHUSER.GETBKHEADID(coalesce(X.BRBK_ID ,Y.BRBK_ID))) AS OPBK_ID
        ,(SELECT BGBK_NAME FROM EACHUSER.BANK_GROUP WHERE BGBK_ID = (SELECT OPBK_ID FROM EACHUSER.BANK_GROUP WHERE BGBK_ID = EACHUSER.GETBKHEADID(coalesce(X.BRBK_ID ,Y.BRBK_ID)))) AS OPBK_NAME
        ,(SELECT EACH_TXN_NAME FROM EACHUSER.EACH_TXN_CODE WHERE EACH_TXN_ID = coalesce(X.PCODE ,Y.PCODE)) AS EACH_TXN_NAME
        ,(SELECT BUSINESS_TYPE_NAME FROM EACHUSER.BUSINESS_TYPE WHERE BUSINESS_TYPE_ID = (select BUSINESS_TYPE_ID from EACHUSER.EACH_TXN_CODE where EACH_TXN_ID=coalesce(X.PCODE ,Y.PCODE))) AS BUSINESS_TYPE_NAME
from
    --應收款(入帳應收+)及(扣款沖正應收+) 
(    select 
        coalesce(a.BIZDATE ,b.BIZDATE) BIZDATE
        ,coalesce(a.CLEARINGPHASE ,b.CLEARINGPHASE) CLEARINGPHASE
        ,coalesce(a.PCODE ,b.PCODE) PCODE
        ,coalesce(a.BRBK_ID ,b.BRBK_ID) BRBK_ID
        ,A.RECVCNT
        ,A.RECVAMT
        ,B.RVSRECVCNT
        ,B.RVSRECVAMT
    from 
    (SELECT
        BIZDATE
       ,CLEARINGPHASE
        ,PCODE
        ,INBANKID BRBK_ID
        ,Count(*) RECVCNT
        ,SUM (NEWTXAMT) RECVAMT
    FROM
        EACHUSER.VW_ONBLOCKTAB 
    Where NEWRESULT != 'R' and SENDERSTATUS != '1'  and CLEARINGPHASE=sPhase and BIZDATE=sBizDATE 
    Group by     BIZDATE , CLEARINGPHASE , PCODE , INBANKID ) A
    FULL OUTER JOIN
    (SELECT
        NEWBIZDATE BIZDATE
        ,NEWCLRPHASE CLEARINGPHASE
        ,PCODE
 -- ,INBANKID BRBK_ID --edit by hugo
,OUTBANKID BRBK_ID 
        ,Count(*)  RVSRECVCNT
        ,0-(SUM (NEWTXAMT))  RVSRECVAMT
    FROM
        EACHUSER.VW_ONPENDING_EC
    Where NEWBIZDATE=sBizDATE and NEWCLRPHASE=sPhase 
    -- Group by     NEWBIZDATE , NEWCLRPHASE , PCODE , INBANKID ) B ----edit by hugo
 Group by     NEWBIZDATE , NEWCLRPHASE , PCODE , OUTBANKID ) B
on B.BIZDATE=A.BIZDATE and B.CLEARINGPHASE=A.CLEARINGPHASE and B.PCODE=A.PCODE and B.BRBK_ID=A.BRBK_ID
)  X
FULL OUTER JOIN
--應付款(扣款應付-)及(入帳沖正應付-)
(    select 
        coalesce(C.BIZDATE ,D.BIZDATE) BIZDATE
        ,coalesce(C.CLEARINGPHASE ,D.CLEARINGPHASE) CLEARINGPHASE
        ,coalesce(C.PCODE ,D.PCODE) PCODE
        ,coalesce(C.BRBK_ID ,D.BRBK_ID) BRBK_ID
        ,C.PAYCNT
        ,C.PAYAMT
        ,D.RVSPAYCNT
        ,D.RVSPAYAMT
    from 
    (SELECT
       BIZDATE
       ,CLEARINGPHASE
        ,PCODE
        ,OUTBANKID BRBK_ID
        ,Count(*)  PAYCNT
        ,0-(SUM (NEWTXAMT)) PAYAMT
    FROM
        EACHUSER.VW_ONBLOCKTAB 
    Where NEWRESULT != 'R' and SENDERSTATUS != '1' and CLEARINGPHASE=sPhase and BIZDATE=sBizDATE 
    Group by     BIZDATE , CLEARINGPHASE ,  PCODE ,OUTBANKID ) C
    FULL OUTER JOIN
    (SELECT
        NEWBIZDATE BIZDATE
        ,NEWCLRPHASE CLEARINGPHASE
        ,PCODE
        --,OUTBANKID BRBK_ID --edit by hugo
,INBANKID BRBK_ID
       ,Count(*) RVSPAYCNT
        ,SUM (NEWTXAMT) RVSPAYAMT
    FROM
        EACHUSER.VW_ONPENDING_EC
    Where NEWBIZDATE=sBizDATE and NEWCLRPHASE=sPhase 
        --Group by     NEWBIZDATE , NEWCLRPHASE , PCODE , OUTBANKID ) D --edit by hugo
Group by     NEWBIZDATE , NEWCLRPHASE , PCODE , INBANKID ) D
on D.BIZDATE=C.BIZDATE and D.CLEARINGPHASE=C.CLEARINGPHASE and D.PCODE=C.PCODE and D.BRBK_ID=C.BRBK_ID
) Y on  Y.BIZDATE=X.BIZDATE and Y.CLEARINGPHASE=X.CLEARINGPHASE and Y.PCODE=X.PCODE and Y.BRBK_ID=X.BRBK_ID
;
commit;

    --20150523 edit by PU
    --Call EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPONCLEARINGTAB', 'S' , sNote );
    CALL EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPONCLEARINGTAB', 'S');

END