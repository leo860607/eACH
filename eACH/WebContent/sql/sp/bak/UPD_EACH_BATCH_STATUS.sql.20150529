
CREATE OR REPLACE PROCEDURE "EACHUSER"."UPD_EACH_BATCH_STATUS"(IN iBIZDATE VARCHAR(10), IN iCLEARINGPHASE VARCHAR(2), IN iBATCH_PROC_NAME VARCHAR(100) ,IN iPROC_STATUS CHAR(1))
	LANGUAGE SQL
BEGIN
	DECLARE EOF INT DEFAULT 0;
	DECLARE sNOTE VARCHAR(300) DEFAULT '';
	DECLARE vBANKID VARCHAR(7);
	DECLARE vONBLOCK_CNT INT;
	DECLARE vPENDING_CNT INT;
	DECLARE vPCODE VARCHAR(4);
	DECLARE vRECVCNT INT;
	DECLARE vRECVAMT BIGINT;
	DECLARE vPAYCNT INT;
	DECLARE vPAYAMT BIGINT;
	DECLARE vRVSRECVCNT INT;
	DECLARE vRVSRECVAMT BIGINT;
	DECLARE vRVSPAYCNT INT;
	DECLARE vRVSPAYAMT BIGINT;
	DECLARE vBALANCEAMT BIGINT;
	DECLARE vAMT DECIMAL(15,2);
	DECLARE vRVSAMT DECIMAL(15,2);
	DECLARE vTEMP1 INT;
	DECLARE vTEMP2 INT;
	DECLARE vTEMP3 INT;
	DECLARE vTEMP4 VARCHAR(300) DEFAULT '';
	DECLARE vTEMP5 VARCHAR(300) DEFAULT '';
	DECLARE vTEMP6 VARCHAR(300) DEFAULT '';
	DECLARE vERROR_RTN VARCHAR(4000) DEFAULT ''; 
    --20150803 add by hugo
    DECLARE endDATE VARCHAR(10) DEFAULT '';--上個月的 endDATE

	DECLARE C1 CURSOR FOR (SELECT VARCHAR(BANKID) AS BANKID, (COALESCE(ONBLOCK_SCNT,0)+COALESCE(ONBLOCK_FCNT,0)+COALESCE(PENDING_CNT,0)) AS ONBLOCK_CNT FROM EACHUSER.EACH_BATCH_DATA_VALIDATION WHERE CLEARINGPHASE = iCLEARINGPHASE and BIZDATE = iBIZDATE);
	DECLARE C2 CURSOR FOR (SELECT VARCHAR(BANKID) AS BANKID, COALESCE(PENDING_CNT,0) AS PENDING_CNT FROM EACHUSER.EACH_BATCH_DATA_VALIDATION WHERE CLEARINGPHASE = iCLEARINGPHASE and BIZDATE = iBIZDATE);
	DECLARE C3 CURSOR FOR (SELECT BANKID, PCODE, RECVCNT, RECVAMT, PAYCNT, PAYAMT, RVSRECVCNT, RVSRECVAMT, RVSPAYCNT, RVSPAYAMT, BALANCEAMT FROM EACHUSER.BHCLEARINGTAB WHERE BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE);
	DECLARE C4 CURSOR FOR (
		SELECT BANKID,
		(SUM(RECVMBFEEAMT) - SUM(PAYMBFEEAMT) - SUM(PAYEACHFEEAMT)) AS AMT,
		(SUM(RVSRECVMBFEEAMT) - SUM(RVSPAYMBFEEAMT) + SUM(RVSRECVEACHFEEAMT)) AS RVSAMT
		FROM EACHUSER.BHCLEARINGTAB
		WHERE BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE
		GROUP BY BIZDATE, CLEARINGPHASE, BANKID
		ORDER BY BIZDATE, CLEARINGPHASE, BANKID
	);
	DECLARE C5 CURSOR FOR (SELECT VARCHAR(BANKID) AS BANKID, ONBLOCK_SCNT, ONBLOCK_FCNT, PENDING_CNT FROM EACHUSER.EACH_BATCH_DATA_VALIDATION WHERE BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE);
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET EOF = 1;


    IF iPROC_STATUS = 'P' THEN
		UPDATE EACHUSER.EACH_BATCH_STATUS SET
		PROC_STATUS = iPROC_STATUS,
		BEGIN_TIME = CURRENT_TIMESTAMP,
		NOTE = sNOTE
		WHERE BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE and BATCH_PROC_NAME = iBATCH_PROC_NAME;
		COMMIT;
    ELSE
		
		IF iBATCH_PROC_NAME = 'BAT_RPONBLOCKTAB' THEN
			SET sNOTE = '總筆數:' || COALESCE((SELECT COUNT(*) FROM EACHUSER.RPONBLOCKTAB WHERE COALESCE(GARBAGEDATA,'') <> '*' AND BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE),0);
			
			OPEN C1;
			FETCH FROM C1 INTO vBANKID, vONBLOCK_CNT;
			WHILE EOF = 0 DO
				SET vTEMP1 = COALESCE((SELECT COUNT(*) FROM EACHUSER.RPONBLOCKTAB WHERE COALESCE(GARBAGEDATA,'') <> '*' AND BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE AND SENDERACQUIRE = vBANKID),0);
				IF NOT(vONBLOCK_CNT = vTEMP1) THEN
					IF LENGTH(vERROR_RTN) = 0 THEN
						SET vERROR_RTN = '@圈存扣款檔筆數不符:;';
					END IF;
					SET vERROR_RTN = vERROR_RTN || vBANKID || ';';
				END IF;
				FETCH FROM C1 INTO vBANKID, vONBLOCK_CNT;
			END WHILE;
			CLOSE C1;
			
			IF LENGTH(vERROR_RTN) = 0 THEN
				SET vERROR_RTN = (
					SELECT
					(CASE WHEN A.ONBLOCK_SCNT = B.ONBLOCK_SCNT THEN '' ELSE '@成功筆數不符!' END) ||
					(CASE WHEN A.ONBLOCK_FCNT = B.ONBLOCK_FCNT THEN '' ELSE '@失敗筆數不符!' END) ||
					(CASE WHEN A.PENDING_CNT = B.PENDING_CNT THEN '' ELSE '@未完成筆數不符!' END) AS sNOTE
					FROM (
						SELECT COALESCE(SUM(ONBLOCK_SCNT),0) AS ONBLOCK_SCNT, COALESCE(SUM(ONBLOCK_FCNT),0) AS ONBLOCK_FCNT, COALESCE(SUM(PENDING_CNT),0) AS PENDING_CNT
						FROM (
							SELECT
							COALESCE((SELECT COUNT(*) FROM EACHUSER.RPONBLOCKTAB AS B WHERE COALESCE(GARBAGEDATA, '') <> '*' AND B.BIZDATE = T.BIZDATE AND B.CLEARINGPHASE = T.CLEARINGPHASE AND B.SENDERACQUIRE = T.BANKID AND B.RESULTSTATUS = 'A'),0) AS ONBLOCK_SCNT,
							COALESCE((SELECT COUNT(*) FROM EACHUSER.RPONBLOCKTAB AS B WHERE COALESCE(GARBAGEDATA, '') <> '*' AND B.BIZDATE = T.BIZDATE AND B.CLEARINGPHASE = T.CLEARINGPHASE AND B.SENDERACQUIRE = T.BANKID AND (B.RESULTSTATUS = 'R' OR (B.RESULTSTATUS = 'P' AND SENDERSTATUS = '1'))),0) AS ONBLOCK_FCNT,
							COALESCE((SELECT COUNT(*) FROM EACHUSER.RPONBLOCKTAB AS B WHERE COALESCE(GARBAGEDATA, '') <> '*' AND SENDERSTATUS <> '1' AND B.BIZDATE = T.BIZDATE AND B.CLEARINGPHASE = T.CLEARINGPHASE AND B.SENDERACQUIRE = T.BANKID AND B.RESULTSTATUS = 'P'),0) AS PENDING_CNT
							FROM (
								SELECT BIZDATE, CLEARINGPHASE, SENDERACQUIRE AS BANKID
								FROM EACHUSER.RPONBLOCKTAB
								WHERE COALESCE(GARBAGEDATA, '') <> '*'
								AND BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE
								GROUP BY BIZDATE, CLEARINGPHASE, SENDERACQUIRE
							) AS T
						)
					) AS A, (
						SELECT COALESCE(SUM(ONBLOCK_SCNT),0) AS ONBLOCK_SCNT, COALESCE(SUM(ONBLOCK_FCNT),0) AS ONBLOCK_FCNT, COALESCE(SUM(PENDING_CNT),0) AS PENDING_CNT
						FROM EACHUSER.EACH_BATCH_DATA_VALIDATION
						WHERE BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE
						GROUP BY BIZDATE, CLEARINGPHASE
					) AS B
				);
			END IF;			
		END IF;
		
		
		IF iBATCH_PROC_NAME = 'BAT_RPONPENDINGTAB' THEN
			SET sNOTE = '總筆數:' || COALESCE((SELECT COUNT(*) FROM EACHUSER.RPONPENDINGTAB WHERE OBIZDATE = iBIZDATE AND OCLEARINGPHASE = iCLEARINGPHASE),0);
			
			OPEN C2;
			FETCH FROM C2 INTO vBANKID, vPENDING_CNT;
			WHILE EOF = 0 DO
				SET vTEMP1 = COALESCE((SELECT COUNT(*) FROM EACHUSER.RPONPENDINGTAB WHERE OBIZDATE = iBIZDATE AND OCLEARINGPHASE = iCLEARINGPHASE AND SENDERACQUIRE = vBANKID),0);
				IF NOT(vPENDING_CNT = vTEMP1) THEN
					IF LENGTH(vERROR_RTN) = 0 THEN
						SET vERROR_RTN = '@未完成筆數不符:;';
					END IF;
					SET vERROR_RTN = vERROR_RTN || vBANKID || ';';
				END IF;
				FETCH FROM C2 INTO vBANKID, vPENDING_CNT;
			END WHILE;
			CLOSE C2;
			
			IF LENGTH(vERROR_RTN) = 0 THEN
				SET vERROR_RTN = (
					SELECT (CASE WHEN A.PENDING_CNT = B.PENDING_CNT THEN '' ELSE '@未完成總筆數不符!' END) AS sNOTE
					FROM (
						SELECT COALESCE(SUM(PENDING_CNT),0) AS PENDING_CNT FROM (
							SELECT COALESCE((SELECT COUNT(*) FROM EACHUSER.RPONPENDINGTAB AS B WHERE B.OBIZDATE = T.OBIZDATE AND B.OCLEARINGPHASE = T.OCLEARINGPHASE AND B.SENDERACQUIRE = T.BANKID),0) AS PENDING_CNT
							FROM (
								SELECT OBIZDATE, OCLEARINGPHASE, SENDERACQUIRE AS BANKID
								FROM EACHUSER.RPONPENDINGTAB WHERE OBIZDATE = iBIZDATE AND OCLEARINGPHASE = iCLEARINGPHASE
								GROUP BY OBIZDATE, OCLEARINGPHASE, SENDERACQUIRE
							) AS T
						)
					) AS A, (
						SELECT COALESCE(SUM(PENDING_CNT),0) AS PENDING_CNT
						FROM EACHUSER.EACH_BATCH_DATA_VALIDATION 
						WHERE BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE
						GROUP BY BIZDATE, CLEARINGPHASE
					) AS B
				);
			END IF;			
		END IF;
		
		
		IF iBATCH_PROC_NAME = 'BAT_RPONCLEARINGTAB' THEN
			SET sNOTE = (
				SELECT
				COALESCE('應收總筆數:' || SUM(COALESCE(RECVCNT,0)) ||
				';應收總金額:' || SUM(COALESCE(RECVAMT,0)) ||
				';應付總筆數:' || SUM(COALESCE(PAYCNT,0)) ||
				';應付總金額:' || SUM(COALESCE(PAYAMT,0)) ||
				';應收沖正總筆數:' || SUM(COALESCE(RVSRECVCNT,0)) ||
				';應收沖正總金額:' || SUM(COALESCE(RVSRECVAMT,0)) ||
				';應付沖正總筆數:' || SUM(COALESCE(RVSPAYCNT,0)) ||
				';應付沖正總金額:' || SUM(COALESCE(RVSPAYAMT,0)),'總筆數:0')
				FROM EACHUSER.RPONCLEARINGTAB
				WHERE BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE
			);
			
			OPEN C3;
			FETCH FROM C3 INTO vBANKID, vPCODE, vRECVCNT, vRECVAMT, vPAYCNT, vPAYAMT, vRVSRECVCNT, vRVSRECVAMT, vRVSPAYCNT, vRVSPAYAMT, vBALANCEAMT;
			WHILE EOF = 0 DO
				SET (vTEMP4, vTEMP5) = (
					SELECT BGBK_ID AS BANKID,
					(CASE SUM(COALESCE(RECVCNT,0)) WHEN vRECVCNT THEN '' ELSE '應收筆數不符' END) ||
					(CASE SUM(COALESCE(RECVAMT,0)) WHEN vRECVAMT THEN '' ELSE ',應收金額不符' END) ||
					(CASE SUM(COALESCE(PAYCNT,0)) WHEN vPAYCNT THEN '' ELSE ',應付筆數不符' END) ||
					(CASE -SUM(COALESCE(PAYAMT,0)) WHEN vPAYAMT THEN '' ELSE ',應付金額不符' END) ||
					(CASE SUM(COALESCE(RVSRECVCNT,0)) WHEN vRVSRECVCNT THEN '' ELSE ',沖正應收筆數不符' END) ||
					(CASE SUM(COALESCE(RVSRECVAMT,0)) WHEN vRVSRECVAMT THEN '' ELSE ',沖正應收金額不符' END) ||
					(CASE SUM(COALESCE(RVSPAYCNT,0)) WHEN vRVSPAYCNT THEN '' ELSE ',沖正應付筆數不符' END) ||
					(CASE -SUM(COALESCE(RVSPAYAMT,0)) WHEN vRVSPAYAMT THEN '' ELSE ',沖正應付金額不符' END) ||
					(CASE (SUM(RECVAMT)+SUM(RVSRECVAMT)+SUM(PAYAMT)+SUM(RVSPAYAMT)) WHEN vBALANCEAMT THEN '' ELSE ',應收付差額不符' END) AS sNOTE
					FROM EACHUSER.RPONCLEARINGTAB
					WHERE BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE
					AND BGBK_ID = vBANKID AND PCODE = vPCODE
					GROUP BY BIZDATE, CLEARINGPHASE, BGBK_ID, PCODE
					ORDER BY BIZDATE, CLEARINGPHASE, BGBK_ID, PCODE
				);
				IF LENGTH(vTEMP5) <> 0 THEN
					SET vERROR_RTN = vERROR_RTN || vTEMP4 || ':' || vTEMP5 || ';';
				END IF;
				FETCH FROM C3 INTO vBANKID, vPCODE, vRECVCNT, vRECVAMT, vPAYCNT, vPAYAMT, vRVSRECVCNT, vRVSRECVAMT, vRVSPAYCNT, vRVSPAYAMT, vBALANCEAMT;
			END WHILE;
			CLOSE C3;
			
			IF LENGTH(vERROR_RTN) = 0 THEN
				SET vERROR_RTN = (
					SELECT
					(CASE WHEN A.RECVCNT = B.RECVCNT THEN '' ELSE '應收總筆數不符' END) ||
					(CASE WHEN A.RECVAMT = B.RECVAMT THEN '' ELSE ',應收總金額不符' END) ||
					(CASE WHEN A.PAYCNT = B.PAYCNT THEN '' ELSE ',應付總筆數不符' END) ||
					(CASE WHEN A.PAYAMT = B.PAYAMT THEN '' ELSE ',應付總金額不符' END) ||
					(CASE WHEN A.RVSRECVCNT = B.RVSRECVCNT THEN '' ELSE ',沖正應收總筆數不符' END) ||
					(CASE WHEN A.RVSRECVAMT = B.RVSRECVAMT THEN '' ELSE ',沖正應收總金額不符' END) ||
					(CASE WHEN A.RVSPAYCNT = B.RVSPAYCNT THEN '' ELSE ',沖正應付總筆數不符' END) ||
					(CASE WHEN A.RVSPAYAMT = B.RVSPAYAMT THEN '' ELSE ',沖正應付總金額不符' END) ||
					(CASE WHEN A.BALANCEAMT = B.BALANCEAMT THEN '' ELSE ',應收付總差額不符' END) AS sNOTE
					FROM (
						SELECT BIZDATE, CLEARINGPHASE,
						COALESCE(SUM(RECVCNT),0) AS RECVCNT,COALESCE(SUM(RECVAMT),0) AS RECVAMT,COALESCE(SUM(PAYCNT),0) AS PAYCNT,COALESCE(-SUM(PAYAMT),0) AS PAYAMT,
						SUM(RVSRECVCNT) AS RVSRECVCNT,SUM(RVSRECVAMT) AS RVSRECVAMT,SUM(RVSPAYCNT) AS RVSPAYCNT,-SUM(RVSPAYAMT) AS RVSPAYAMT,
						(SUM(RECVAMT)+SUM(PAYAMT)+SUM(RVSRECVAMT)+SUM(RVSPAYAMT)) AS BALANCEAMT
						FROM EACHUSER.RPONCLEARINGTAB
						WHERE BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE
						GROUP BY BIZDATE, CLEARINGPHASE
					) AS A, (
						SELECT BIZDATE, CLEARINGPHASE,
						SUM(RECVCNT) AS RECVCNT,SUM(RECVAMT) AS RECVAMT,SUM(PAYCNT) AS PAYCNT,SUM(PAYAMT) AS PAYAMT,
						SUM(RVSRECVCNT) AS RVSRECVCNT,SUM(RVSRECVAMT) AS RVSRECVAMT,SUM(RVSPAYCNT) AS RVSPAYCNT,SUM(RVSPAYAMT) AS RVSPAYAMT,
						SUM(BALANCEAMT) AS BALANCEAMT
						FROM EACHUSER.BHCLEARINGTAB
						WHERE BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE
						GROUP BY BIZDATE, CLEARINGPHASE
					) AS B
				);
				IF LENGTH(vERROR_RTN) <> 0 THEN
					SET vERROR_RTN = '@' || vERROR_RTN;
				END IF;
			END IF;
		END IF;
		
		
		IF iBATCH_PROC_NAME = 'BAT_RPCLEARFEETAB' THEN
			SET sNOTE = COALESCE((
				SELECT '總筆數:' || COUNT(*) || ';應收付手續費總金額:' || SUM(AMT) || ';沖正應收付手續費總金額:' || SUM(RVSAMT)
				FROM EACHUSER.RPCLEARFEETAB
				WHERE BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE
			),'總筆數:0');
			
			OPEN C4;
			FETCH FROM C4 INTO vBANKID, vAMT, vRVSAMT;
			WHILE EOF = 0 DO
				SET vTEMP4 = (
					SELECT
					(CASE WHEN SUM(AMT) = vAMT THEN '' ELSE '應收付手續費總金額不符' END) ||
					(CASE WHEN SUM(RVSAMT) = vRVSAMT THEN '' ELSE ',沖正應收付手續費總金額不符' END) AS sNOTE
					FROM EACHUSER.RPCLEARFEETAB
					WHERE BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE
					AND BGBK_ID = vBANKID
					GROUP BY BIZDATE, CLEARINGPHASE, BGBK_ID
				);
				IF LENGTH(vTEMP4) <> 0 THEN
					SET vERROR_RTN = vERROR_RTN || vBANKID || ':' || vTEMP4 || ';';
				END IF;
				FETCH FROM C4 INTO vBANKID, vAMT, vRVSAMT;
			END WHILE;
			CLOSE C4;
			
			IF LENGTH(vERROR_RTN) = 0 THEN
				SET vERROR_RTN = (
					SELECT
					(CASE WHEN COALESCE(SUM(A.AMT),0) = COALESCE(SUM(B.AMT),0) THEN '' ELSE '應收付手續費總金額不符' END) ||
					(CASE WHEN COALESCE(SUM(A.RVSAMT),0) = COALESCE(SUM(B.RVSAMT),0) THEN '' ELSE ',沖正應收付手續費總金額不符' END) AS sNOTE
					FROM (
						SELECT SUM(AMT) AS AMT, SUM(RVSAMT) AS RVSAMT
						FROM EACHUSER.RPCLEARFEETAB
						WHERE BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE
						GROUP BY BIZDATE, CLEARINGPHASE, BGBK_ID
					) AS A, (
						SELECT
						(SUM(RECVMBFEEAMT) - SUM(PAYMBFEEAMT) - SUM(PAYEACHFEEAMT)) AS AMT,
						(SUM(RVSRECVMBFEEAMT) - SUM(RVSPAYMBFEEAMT) + SUM(RVSRECVEACHFEEAMT)) AS RVSAMT
						FROM EACHUSER.BHCLEARINGTAB
						WHERE BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE
						GROUP BY BIZDATE, CLEARINGPHASE, BANKID
					) AS B
				);
				IF LENGTH(vERROR_RTN) <> 0 THEN
					SET vERROR_RTN = '@' || vERROR_RTN;
				END IF;
			END IF;			
		END IF;
		
		
		IF iBATCH_PROC_NAME = 'BAT_RPDAILYSUM' THEN
			SET sNOTE = '總筆數:' || COALESCE((SELECT SUM(CNT) FROM EACHUSER.RPDAILYSUMTAB WHERE BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE AND OP_TYPE = 'S'),0);
			
			OPEN C5;
			FETCH FROM C5 INTO vBANKID, vTEMP1, vTEMP2, vTEMP3;
			WHILE EOF = 0 DO
				SET vTEMP4 = (
					SELECT
					(CASE COALESCE((SELECT SUM(CNT) FROM EACHUSER.RPDAILYSUMTAB AS B WHERE B.BIZDATE = A.BIZDATE AND B.CLEARINGPHASE = A.CLEARINGPHASE AND B.OP_TYPE = A.OP_TYPE AND B.OPBK_ID = A.OPBK_ID AND RESULTSTATUS = 'A'),0) WHEN vTEMP1 THEN '' ELSE '成功筆數不符!' END) ||
					(CASE COALESCE((SELECT SUM(CNT) FROM EACHUSER.RPDAILYSUMTAB AS B WHERE B.BIZDATE = A.BIZDATE AND B.CLEARINGPHASE = A.CLEARINGPHASE AND B.OP_TYPE = A.OP_TYPE AND B.OPBK_ID = A.OPBK_ID AND RESULTSTATUS = 'R'),0) WHEN vTEMP2 THEN '' ELSE '失敗筆數不符!' END) ||
					(CASE COALESCE((SELECT SUM(CNT) FROM EACHUSER.RPDAILYSUMTAB AS B WHERE B.BIZDATE = A.BIZDATE AND B.CLEARINGPHASE = A.CLEARINGPHASE AND B.OP_TYPE = A.OP_TYPE AND B.OPBK_ID = A.OPBK_ID AND RESULTSTATUS = 'P'),0) WHEN vTEMP3 THEN '' ELSE '未完成筆數不符' END) AS sNOTE
					FROM EACHUSER.RPDAILYSUMTAB AS A
					WHERE A.BIZDATE = iBIZDATE AND A.CLEARINGPHASE = iCLEARINGPHASE AND A.OP_TYPE = 'S'
					AND A.OPBK_ID = vBANKID
					GROUP BY A.BIZDATE, A.CLEARINGPHASE, A.OP_TYPE, A.OPBK_ID
				);
				IF LENGTH(vTEMP4) <> 0 THEN
					SET vERROR_RTN = vERROR_RTN || vBANKID || ':' || vTEMP4 || ';';
				END IF;
				FETCH FROM C5 INTO vBANKID, vTEMP1, vTEMP2, vTEMP3;
			END WHILE;
			CLOSE C5;
			
			IF LENGTH(vERROR_RTN) = 0 THEN
				SET vERROR_RTN = (
					SELECT 
					(CASE WHEN A.ONBLOCK_SCNT = B.ONBLOCK_SCNT THEN '' ELSE '成功總筆數不相符!' END) ||
					(CASE WHEN A.ONBLOCK_FCNT = B.ONBLOCK_FCNT THEN '' ELSE '失敗總筆數不相符!' END) ||
					(CASE WHEN A.PENDING_CNT = B.PENDING_CNT THEN '' ELSE '未完成總筆數不相符!' END) AS sNOTE
					FROM (
						SELECT
						COALESCE((SELECT SUM(CNT) FROM EACHUSER.RPDAILYSUMTAB AS B WHERE B.BIZDATE = A.BIZDATE AND B.CLEARINGPHASE = A.CLEARINGPHASE AND B.OP_TYPE = A.OP_TYPE AND RESULTSTATUS = 'A'),0) AS ONBLOCK_SCNT,
						COALESCE((SELECT SUM(CNT) FROM EACHUSER.RPDAILYSUMTAB AS B WHERE B.BIZDATE = A.BIZDATE AND B.CLEARINGPHASE = A.CLEARINGPHASE AND B.OP_TYPE = A.OP_TYPE AND RESULTSTATUS = 'R'),0) AS ONBLOCK_FCNT,
						COALESCE((SELECT SUM(CNT) FROM EACHUSER.RPDAILYSUMTAB AS B WHERE B.BIZDATE = A.BIZDATE AND B.CLEARINGPHASE = A.CLEARINGPHASE AND B.OP_TYPE = A.OP_TYPE AND RESULTSTATUS = 'P'),0) AS PENDING_CNT
						FROM EACHUSER.RPDAILYSUMTAB AS A
						WHERE A.BIZDATE = iBIZDATE AND A.CLEARINGPHASE = iCLEARINGPHASE AND A.OP_TYPE = 'S'
						GROUP BY A.BIZDATE, A.CLEARINGPHASE, A.OP_TYPE
					) AS A, (
						SELECT
						COALESCE(SUM(ONBLOCK_SCNT),0) AS ONBLOCK_SCNT, COALESCE(SUM(ONBLOCK_FCNT),0) AS ONBLOCK_FCNT, COALESCE(SUM(PENDING_CNT),0) AS PENDING_CNT
						FROM EACHUSER.EACH_BATCH_DATA_VALIDATION
						WHERE BIZDATE  = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE
					) AS B
				);
				IF LENGTH(vERROR_RTN) <> 0 THEN
					SET vERROR_RTN = '@' || vERROR_RTN;
				END IF;
			END IF;
		END IF;
		
		
		IF iBATCH_PROC_NAME = 'BAT_RPMONTHSUM' THEN
        SET endDATE = to_char(Date(substr(iBIZDATE,1,4) || '-' || substr(iBIZDATE,5,2) || '-01 00:00:00') - 1 Days , 'yyyymmdd');

			IF iPROC_STATUS = 'N' THEN
				SET sNOTE = '不執行';
			ELSE
                --20150803 edit by hugo  YYYYMM = '201504'  不可寫死
				--SET sNOTE = '總筆數:' || COALESCE((SELECT SUM(CNT) FROM EACHUSER.RPMONTHSUMTAB WHERE YYYYMM = '201504' AND OP_TYPE = 'S'),0);
                SET sNOTE = '總筆數:' || COALESCE((SELECT SUM(CNT) FROM EACHUSER.RPMONTHSUMTAB WHERE YYYYMM = substr(endDATE,1,6)  AND OP_TYPE = 'S'),0);
            END IF;
		END IF;		
		
		
		IF LENGTH(vERROR_RTN) > 0 THEN
			UPDATE EACHUSER.EACH_BATCH_STATUS SET
			PROC_STATUS = 'F',
			END_TIME = CURRENT_TIMESTAMP,
			NOTE = vERROR_RTN
			WHERE BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE AND BATCH_PROC_NAME = iBATCH_PROC_NAME;


        ELSEIF iPROC_STATUS = 'N' THEN 
            UPDATE EACHUSER.EACH_BATCH_STATUS SET
			PROC_STATUS = iPROC_STATUS,         
            END_TIME = '',
			NOTE = sNOTE
			WHERE BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE AND BATCH_PROC_NAME = iBATCH_PROC_NAME;		

		ELSE
			UPDATE EACHUSER.EACH_BATCH_STATUS SET
			PROC_STATUS = iPROC_STATUS,
			END_TIME = CURRENT_TIMESTAMP,
			NOTE = sNOTE
			WHERE BIZDATE = iBIZDATE AND CLEARINGPHASE = iCLEARINGPHASE AND BATCH_PROC_NAME = iBATCH_PROC_NAME;
		END IF;
		COMMIT;
	END IF;
END
GO
