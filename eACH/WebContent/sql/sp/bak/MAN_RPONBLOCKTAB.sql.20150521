
CREATE OR REPLACE PROCEDURE EACHUSER.MAN_RPONBLOCKTAB (in sBizDATE varchar(10), in sPhase varchar(2))
	LANGUAGE SQL
BEGIN
	
     
    Declare begDATE VARCHAR(10);
    Declare sPREVDATE VARCHAR(10);
    Declare OnBlock_CNT VARCHAR(10);
    Declare OnPending_CNT VARCHAR(10);
	
    

    
    
    CALL EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPONBLOCKTAB', 'P');  

 SET begDATE =  to_char(Date(substr(sBIZDATE,1,4) || '-' || substr(sBIZDATE,5,2) || '-' || substr(sBIZDATE,7,2) ||' 00:00:00') - 1 Month , 'yyyymmdd') ;
   
    SET sPREVDATE =(SELECT TRANS_DATE FROM (
                                            SELECT EACHUSER.TRANS_DATE(txn_date,'W','') TRANS_DATE  ,row_number()  OVER (ORDER BY txn_date desc) row_num
                                            FROM	EACHUSER.WK_DATE_CALENDAR 
                                            where (txn_date > EACHUSER.TRANS_DATE(begDATE,'T','') and txn_date < EACHUSER.TRANS_DATE(sBIZDATE,'T','') ) and IS_TXN_DATE='Y' )
                                        where row_num =1);
 

Delete EACHUSER.RPONBLOCKTAB Where CLEARINGPHASE =sPhase and BizDATE=sBizDATE ;

INSERT INTO EACHUSER.RPONBLOCKTAB( NEWRESULT,  TXDATE, STAN, PCODE, SENDERBANK, RECEIVERBANK, TXDT, SENDERSTATUS, RECEIVERSTATUS, TIMEOUTCODE, CONRESULTCODE, ACCTCODE, CLEARINGCODE, PENDINGCODE, SENDERCLEARING, INCLEARING, OUTCLEARING, SENDERACQUIRE, INACQUIRE, OUTACQUIRE, SENDERHEAD, INHEAD, OUTHEAD, SENDERFEE, INFEE, OUTFEE, EACHFEE, REFUNDDEADLINE, SENDERID, RECEIVERID, TXID, TXAMT, FEE, SENDERBANKID, INBANKID, OUTBANKID, BIZDATE, EACHDT, CLEARINGPHASE, INACCTNO, OUTACCTNO, INID, OUTID, ACCTBAL, AVAILBAL, CHECKTYPE, MERCHANTID, ORDERNO, TRMLID, TRMLCHECK, TRMLMCC, BANKRSPMSG, RRN, RESULTSTATUS, RC1, RC2, RC3, RC4, RC5, RC6, UPDATEDT, CONMEMO,COMPANY_ABBR ,FLBIZDATE, FLPROCSEQ, FLBATCHSEQ,DATASEQ) 
SELECT
RESULTSTATUS NEWRESULT ,    
	TXDATE,
	STAN,
	PCODE,
	SENDERBANK,
	RECEIVERBANK,
	
NEWTXDT,
	SENDERSTATUS,
	RECEIVERSTATUS,
	TIMEOUTCODE,
	CONRESULTCODE,
	ACCTCODE,
	CLEARINGCODE,
	PENDINGCODE,
	SENDERCLEARING,
	INCLEARING,
	OUTCLEARING,
	SENDERACQUIRE,
	INACQUIRE,
	OUTACQUIRE,
	SENDERHEAD,
	INHEAD,
	OUTHEAD,
NEWSENDERFEE,
NEWINFEE,
NEWOUTFEE,
NEWEACHFEE,
	REFUNDDEADLINE,
	SENDERID,
	RECEIVERID,
	TXID,
NEWTXAMT,
NEWFEE,
	SENDERBANKID,
	INBANKID,
	OUTBANKID,
	BIZDATE,
	EACHDT,
	CLEARINGPHASE,
	INACCTNO,
	OUTACCTNO,
	INID,
	OUTID,
	ACCTBAL,
	AVAILBAL,
	CHECKTYPE,
	MERCHANTID,
	ORDERNO,
	TRMLID,
	TRMLCHECK,
	TRMLMCC,
	BANKRSPMSG,
	RRN,
	RESULTSTATUS,
	RC1,
	RC2,
	RC3,
	RC4,
	RC5,
	RC6, 
    UPDATEDT,	
    CONMEMO,
    EACHUSER.GETCOMPANY_ABBR(SENDERID) COMPANY_ABBR,
    FLBIZDATE, FLPROCSEQ, FLBATCHSEQ,DATASEQ
FROM
	EACHUSER.VW_ONBLOCKTAB
Where  COALESCE(GARBAGEDATA,'') <> '*'  and CLEARINGPHASE =sPhase and BIZDATE =sBizDATE 
;
commit;
  
    
    CALL EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPONBLOCKTAB', 'S');

    CALL EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPONPENDINGTAB', 'P');

--處理未完成交易資料
Delete EACHUSER.RPONPENDINGTAB Where OCLEARINGPHASE =sPhase and OBIZDATE =sBizDATE;
INSERT INTO EACHUSER.RPONPENDINGTAB( RESP, OTXDATE, OSTAN, PCODE, CLEARINGCODE, OBIZDATE, OCLEARINGPHASE, BIZDATE, CLEARINGPHASE, RESULTCODE, SENDERBANK, SENDERCLEARING, INCLEARING, OUTCLEARING, SENDERACQUIRE, INACQUIRE, OUTACQUIRE, SENDERHEAD, INHEAD, OUTHEAD, SENDERFEE, INFEE, OUTFEE, EACHFEE, TXAMT, SENDERBANKID, OUTBANKID, INBANKID, OUTACCT, INACCT, ACHFLAG, TXOBIZDATE, TXOCLEARINGPHASE,	TXBIZDATE,	TXCLEARINGPHASE, CDATE, TXDT, SENDERID, TXID) 
SELECT
   EACHUSER.GETRESPDESC(oTxDate,oStan) RESP
  
    ,OTXDATE, OSTAN, PCODE, CLEARINGCODE, OBIZDATE, OCLEARINGPHASE, BIZDATE, CLEARINGPHASE, RESULTCODE, SENDERBANK, SENDERCLEARING, INCLEARING, OUTCLEARING, SENDERACQUIRE, INACQUIRE, OUTACQUIRE, SENDERHEAD, INHEAD, OUTHEAD, SENDERFEE, INFEE, OUTFEE, EACHFEE, TXAMT, SENDERBANKID, OUTBANKID, INBANKID, OUTACCT, INACCT, ACHFLAG, TXOBIZDATE, TXOCLEARINGPHASE,	TXBIZDATE,	TXCLEARINGPHASE, CURRENT TIMESTAMP, TXDT, SENDERID, TXID
FROM
	EACHUSER.ONPENDINGTAB a Where  OCLEARINGPHASE =sPhase and OBIZDATE =sBizDATE
;
commit;

--處理未完成交易結果資料(未完成交易如有結果 ONPENDINGTAB 的BIZDATE CLEARINGPHASE 會有值 )
MERGE INTO  EACHUSER.RPONPENDINGTAB A
USING (
    SELECT EACHUSER.GETRESPDESC(oTxDate,oStan) RESP ,OTXDATE, OSTAN, PCODE, CLEARINGCODE, OBIZDATE, OCLEARINGPHASE, BIZDATE, CLEARINGPHASE
    , RESULTCODE, SENDERBANK, SENDERCLEARING, INCLEARING, OUTCLEARING, SENDERACQUIRE, INACQUIRE, OUTACQUIRE, SENDERHEAD, INHEAD, OUTHEAD, SENDERFEE
    , INFEE, OUTFEE, EACHFEE, TXAMT, SENDERBANKID, OUTBANKID, INBANKID, OUTACCT, INACCT, ACHFLAG, TXOBIZDATE, TXOCLEARINGPHASE,	TXBIZDATE
    , TXCLEARINGPHASE, CURRENT TIMESTAMP, TXDT, SENDERID, TXID
    FROM EACHUSER.ONPENDINGTAB  
    Where  CLEARINGPHASE =sPhase and BIZDATE =sBizDATE
 ) B
ON (A.OBIZDATE = B.OBIZDATE AND A.OCLEARINGPHASE = B.OCLEARINGPHASE AND A.OSTAN = B.OSTAN)
WHEN MATCHED THEN
UPDATE SET 
( RESP, OTXDATE, OSTAN, PCODE, CLEARINGCODE, BIZDATE, CLEARINGPHASE, RESULTCODE, SENDERBANK, SENDERCLEARING, INCLEARING, OUTCLEARING, SENDERACQUIRE, INACQUIRE, OUTACQUIRE, SENDERHEAD, INHEAD, OUTHEAD, SENDERFEE, INFEE, OUTFEE, EACHFEE, TXAMT, SENDERBANKID, OUTBANKID, INBANKID, OUTACCT, INACCT, ACHFLAG, TXOBIZDATE, TXOCLEARINGPHASE,	TXBIZDATE,	TXCLEARINGPHASE, TXDT, SENDERID, TXID) 
=
 ( B.RESP , B.OTXDATE, B.OSTAN, B.PCODE, B.CLEARINGCODE, B.BIZDATE, B.CLEARINGPHASE, B.RESULTCODE, B.SENDERBANK, B.SENDERCLEARING, B.INCLEARING, B.OUTCLEARING, B.SENDERACQUIRE, B.INACQUIRE, B.OUTACQUIRE, B.SENDERHEAD, B.INHEAD, B.OUTHEAD, B.SENDERFEE, B.INFEE, B.OUTFEE, B.EACHFEE, B.TXAMT, B.SENDERBANKID, B.OUTBANKID, B.INBANKID, B.OUTACCT, B.INACCT, B.ACHFLAG, B.TXOBIZDATE, B.TXOCLEARINGPHASE,	B.TXBIZDATE,	B.TXCLEARINGPHASE , B.TXDT, B.SENDERID, B.TXID)
;
commit;


    CALL EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPONPENDINGTAB', 'S');
END
GO






--=======================以下為備用版尚未實際測試 20160303 add by hugo ================================================
/*
擔心UPDATE的方式會有不可預期的問題用另外的方式全都用DELETE INSERT的方式
邏輯如下:
A:假設目前執行BIZDATE=20160303  CLEARINGPHASE = 01的資料
1.先處理未完成交易資料
DELETE INSERT RPONPENDINGTAB OBIZDATE=20160303  OCLEARINGPHASE=01的資料
SELECT ONPENDINGTAB OBIZDATE=20160303  OCLEARINGPHASE=01 INSERT 2 RPONPENDINGTAB
2.處理未完成交易結果的資料 (把前一個營業日20160301 ，01、02 階段的資料重新轉移)
DELETE INSERT RPONPENDINGTAB OBIZDATE=20160302
SELECT ONPENDINGTAB OBIZDATE=20160302  INSERT 2 RPONPENDINGTAB

B:假設目前執行BIZDATE=20160303  CLEARINGPHASE = 02的資料
1.先處理未完成交易資料
DELETE INSERT RPONPENDINGTAB OBIZDATE=20160303  OCLEARINGPHASE=02的資料
SELECT ONPENDINGTAB OBIZDATE=20160303  OCLEARINGPHASE=02 INSERT 2 RPONPENDINGTAB
2.處理未完成交易結果的資料 (把前一個營業日20160303 ，01階段的資料重新轉移)
DELETE INSERT RPONPENDINGTAB OBIZDATE=20160303 OCLEARINGPHASE=01的資料
SELECT ONPENDINGTAB OBIZDATE=20160303 OCLEARINGPHASE=01 INSERT 2 RPONPENDINGTAB
3.處理未完成交易結果的資料 (把前一個營業日20160302 ，02階段的資料重新轉移)
DELETE INSERT RPONPENDINGTAB OBIZDATE=20160302 OCLEARINGPHASE=02的資料
SELECT ONPENDINGTAB OBIZDATE=20160302 OCLEARINGPHASE=02 INSERT 2 RPONPENDINGTAB
*/


CREATE OR REPLACE PROCEDURE EACHUSER.MAN_RPONBLOCKTAB (in sBizDATE varchar(10), in sPhase varchar(2))
	LANGUAGE SQL
BEGIN
	
     
    Declare begDATE VARCHAR(10);
    Declare sPREVDATE VARCHAR(10);
    Declare OnBlock_CNT VARCHAR(10);
    Declare OnPending_CNT VARCHAR(10);
    Declare tmpPhase VARCHAR(2);
	
    

    
    
    CALL EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPONBLOCKTAB', 'P');  

 SET begDATE =  to_char(Date(substr(sBIZDATE,1,4) || '-' || substr(sBIZDATE,5,2) || '-' || substr(sBIZDATE,7,2) ||' 00:00:00') - 1 Month , 'yyyymmdd') ;
   
    SET sPREVDATE =(SELECT TRANS_DATE FROM (
                                            SELECT EACHUSER.TRANS_DATE(txn_date,'W','') TRANS_DATE  ,row_number()  OVER (ORDER BY txn_date desc) row_num
                                            FROM	EACHUSER.WK_DATE_CALENDAR 
                                            where (txn_date > EACHUSER.TRANS_DATE(begDATE,'T','') and txn_date < EACHUSER.TRANS_DATE(sBIZDATE,'T','') ) and IS_TXN_DATE='Y' )
                                        where row_num =1);


Delete EACHUSER.RPONBLOCKTAB Where CLEARINGPHASE =sPhase and BizDATE=sBizDATE ;

INSERT INTO EACHUSER.RPONBLOCKTAB( NEWRESULT,  TXDATE, STAN, PCODE, SENDERBANK, RECEIVERBANK, TXDT, SENDERSTATUS, RECEIVERSTATUS, TIMEOUTCODE, CONRESULTCODE, ACCTCODE, CLEARINGCODE, PENDINGCODE, SENDERCLEARING, INCLEARING, OUTCLEARING, SENDERACQUIRE, INACQUIRE, OUTACQUIRE, SENDERHEAD, INHEAD, OUTHEAD, SENDERFEE, INFEE, OUTFEE, EACHFEE, REFUNDDEADLINE, SENDERID, RECEIVERID, TXID, TXAMT, FEE, SENDERBANKID, INBANKID, OUTBANKID, BIZDATE, EACHDT, CLEARINGPHASE, INACCTNO, OUTACCTNO, INID, OUTID, ACCTBAL, AVAILBAL, CHECKTYPE, MERCHANTID, ORDERNO, TRMLID, TRMLCHECK, TRMLMCC, BANKRSPMSG, RRN, RESULTSTATUS, RC1, RC2, RC3, RC4, RC5, RC6, UPDATEDT, CONMEMO,COMPANY_ABBR ,FLBIZDATE, FLPROCSEQ, FLBATCHSEQ,DATASEQ) 
SELECT
RESULTSTATUS NEWRESULT ,    
	TXDATE,
	STAN,
	PCODE,
	SENDERBANK,
	RECEIVERBANK,
	
NEWTXDT,
	SENDERSTATUS,
	RECEIVERSTATUS,
	TIMEOUTCODE,
	CONRESULTCODE,
	ACCTCODE,
	CLEARINGCODE,
	PENDINGCODE,
	SENDERCLEARING,
	INCLEARING,
	OUTCLEARING,
	SENDERACQUIRE,
	INACQUIRE,
	OUTACQUIRE,
	SENDERHEAD,
	INHEAD,
	OUTHEAD,
NEWSENDERFEE,
NEWINFEE,
NEWOUTFEE,
NEWEACHFEE,
	REFUNDDEADLINE,
	SENDERID,
	RECEIVERID,
	TXID,
NEWTXAMT,
NEWFEE,
	SENDERBANKID,
	INBANKID,
	OUTBANKID,
	BIZDATE,
	EACHDT,
	CLEARINGPHASE,
	INACCTNO,
	OUTACCTNO,
	INID,
	OUTID,
	ACCTBAL,
	AVAILBAL,
	CHECKTYPE,
	MERCHANTID,
	ORDERNO,
	TRMLID,
	TRMLCHECK,
	TRMLMCC,
	BANKRSPMSG,
	RRN,
	RESULTSTATUS,
	RC1,
	RC2,
	RC3,
	RC4,
	RC5,
	RC6, 
    UPDATEDT,	
    CONMEMO,
    EACHUSER.GETCOMPANY_ABBR(SENDERID) COMPANY_ABBR,
    FLBIZDATE, FLPROCSEQ, FLBATCHSEQ,DATASEQ
FROM
	EACHUSER.VW_ONBLOCKTAB
Where  COALESCE(GARBAGEDATA,'') <> '*'  and CLEARINGPHASE =sPhase and BIZDATE =sBizDATE 
;
commit;
   
    CALL EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPONBLOCKTAB', 'S');
    
    CALL EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPONPENDINGTAB', 'P');

--以下轉處理未完成資料
Delete EACHUSER.RPONPENDINGTAB Where OCLEARINGPHASE =sPhase and OBIZDATE =sBizDATE;
INSERT INTO EACHUSER.RPONPENDINGTAB( RESP, OTXDATE, OSTAN, PCODE, CLEARINGCODE, OBIZDATE, OCLEARINGPHASE, BIZDATE, CLEARINGPHASE, RESULTCODE, SENDERBANK, SENDERCLEARING, INCLEARING, OUTCLEARING, SENDERACQUIRE, INACQUIRE, OUTACQUIRE, SENDERHEAD, INHEAD, OUTHEAD, SENDERFEE, INFEE, OUTFEE, EACHFEE, TXAMT, SENDERBANKID, OUTBANKID, INBANKID, OUTACCT, INACCT, ACHFLAG, TXOBIZDATE, TXOCLEARINGPHASE,	TXBIZDATE,	TXCLEARINGPHASE, CDATE, TXDT, SENDERID, TXID) 
SELECT
   EACHUSER.GETRESPDESC(oTxDate,oStan) RESP
  
    ,OTXDATE, OSTAN, PCODE, CLEARINGCODE, OBIZDATE, OCLEARINGPHASE, BIZDATE, CLEARINGPHASE, RESULTCODE, SENDERBANK, SENDERCLEARING, INCLEARING, OUTCLEARING, SENDERACQUIRE, INACQUIRE, OUTACQUIRE, SENDERHEAD, INHEAD, OUTHEAD, SENDERFEE, INFEE, OUTFEE, EACHFEE, TXAMT, SENDERBANKID, OUTBANKID, INBANKID, OUTACCT, INACCT, ACHFLAG, TXOBIZDATE, TXOCLEARINGPHASE,	TXBIZDATE,	TXCLEARINGPHASE, CURRENT TIMESTAMP, TXDT, SENDERID, TXID
FROM
	EACHUSER.ONPENDINGTAB a Where  OCLEARINGPHASE =sPhase and OBIZDATE =sBizDATE
;
commit;
--未完成處理完畢
--IF sPhase ='02' THEN tmpPhase = '01' ELSE tmpPhase = '02'  END IF ;

--以下處理未完成交易結果資料
IF sPhase = '02' THEN 
--執行同一營業日上個階段的資料
SET tmpPhase = '01' ;
Delete EACHUSER.RPONPENDINGTAB Where OCLEARINGPHASE =tmpPhase and OBIZDATE =sBizDATE;
INSERT INTO EACHUSER.RPONPENDINGTAB( RESP, OTXDATE, OSTAN, PCODE, CLEARINGCODE, OBIZDATE, OCLEARINGPHASE, BIZDATE, CLEARINGPHASE, RESULTCODE, SENDERBANK, SENDERCLEARING, INCLEARING, OUTCLEARING, SENDERACQUIRE, INACQUIRE, OUTACQUIRE, SENDERHEAD, INHEAD, OUTHEAD, SENDERFEE, INFEE, OUTFEE, EACHFEE, TXAMT, SENDERBANKID, OUTBANKID, INBANKID, OUTACCT, INACCT, ACHFLAG, TXOBIZDATE, TXOCLEARINGPHASE,	TXBIZDATE,	TXCLEARINGPHASE, CDATE, TXDT, SENDERID, TXID ,FLBIZDATE, FLPROCSEQ, FLBATCHSEQ,DATASEQ) 
SELECT
   EACHUSER.GETRESPDESC(oTxDate,oStan) RESP
  -- , a.*
  ,OTXDATE, OSTAN, PCODE, CLEARINGCODE, OBIZDATE, OCLEARINGPHASE, BIZDATE, CLEARINGPHASE, RESULTCODE, SENDERBANK, SENDERCLEARING, INCLEARING, OUTCLEARING, SENDERACQUIRE, INACQUIRE, OUTACQUIRE, SENDERHEAD, INHEAD, OUTHEAD, SENDERFEE, INFEE, OUTFEE, EACHFEE, TXAMT, SENDERBANKID, OUTBANKID, INBANKID, OUTACCT, INACCT, ACHFLAG, TXOBIZDATE, TXOCLEARINGPHASE,	TXBIZDATE,	TXCLEARINGPHASE, CURRENT TIMESTAMP, TXDT, SENDERID, TXID ,FLBIZDATE, FLPROCSEQ, FLBATCHSEQ,DATASEQ
FROM
	EACHUSER.ONPENDINGTAB a Where  OCLEARINGPHASE =tmpPhase and OBIZDATE =sBizDATE
;
commit;

--執行同上個營業日相同階段的資料
Delete EACHUSER.RPONPENDINGTAB Where OCLEARINGPHASE =sPhase and OBIZDATE =sPREVDATE;
INSERT INTO EACHUSER.RPONPENDINGTAB( RESP, OTXDATE, OSTAN, PCODE, CLEARINGCODE, OBIZDATE, OCLEARINGPHASE, BIZDATE, CLEARINGPHASE, RESULTCODE, SENDERBANK, SENDERCLEARING, INCLEARING, OUTCLEARING, SENDERACQUIRE, INACQUIRE, OUTACQUIRE, SENDERHEAD, INHEAD, OUTHEAD, SENDERFEE, INFEE, OUTFEE, EACHFEE, TXAMT, SENDERBANKID, OUTBANKID, INBANKID, OUTACCT, INACCT, ACHFLAG, TXOBIZDATE, TXOCLEARINGPHASE,	TXBIZDATE,	TXCLEARINGPHASE, CDATE, TXDT, SENDERID, TXID ,FLBIZDATE, FLPROCSEQ, FLBATCHSEQ,DATASEQ) 
SELECT
   EACHUSER.GETRESPDESC(oTxDate,oStan) RESP
  -- , a.*
  ,OTXDATE, OSTAN, PCODE, CLEARINGCODE, OBIZDATE, OCLEARINGPHASE, BIZDATE, CLEARINGPHASE, RESULTCODE, SENDERBANK, SENDERCLEARING, INCLEARING, OUTCLEARING, SENDERACQUIRE, INACQUIRE, OUTACQUIRE, SENDERHEAD, INHEAD, OUTHEAD, SENDERFEE, INFEE, OUTFEE, EACHFEE, TXAMT, SENDERBANKID, OUTBANKID, INBANKID, OUTACCT, INACCT, ACHFLAG, TXOBIZDATE, TXOCLEARINGPHASE,	TXBIZDATE,	TXCLEARINGPHASE, CURRENT TIMESTAMP, TXDT, SENDERID, TXID ,FLBIZDATE, FLPROCSEQ, FLBATCHSEQ,DATASEQ
FROM
	EACHUSER.ONPENDINGTAB a Where  OCLEARINGPHASE =sPhase and OBIZDATE =sPREVDATE
;
commit;

ELSE --如果是01階段 直接轉移尚一個營業日所有資料(不分階段)
SET tmpPhase = '02'; 
Delete EACHUSER.RPONPENDINGTAB Where OBIZDATE =sPREVDATE;
INSERT INTO EACHUSER.RPONPENDINGTAB( RESP, OTXDATE, OSTAN, PCODE, CLEARINGCODE, OBIZDATE, OCLEARINGPHASE, BIZDATE, CLEARINGPHASE, RESULTCODE, SENDERBANK, SENDERCLEARING, INCLEARING, OUTCLEARING, SENDERACQUIRE, INACQUIRE, OUTACQUIRE, SENDERHEAD, INHEAD, OUTHEAD, SENDERFEE, INFEE, OUTFEE, EACHFEE, TXAMT, SENDERBANKID, OUTBANKID, INBANKID, OUTACCT, INACCT, ACHFLAG, TXOBIZDATE, TXOCLEARINGPHASE,	TXBIZDATE,	TXCLEARINGPHASE, CDATE, TXDT, SENDERID, TXID ,FLBIZDATE, FLPROCSEQ, FLBATCHSEQ,DATASEQ) 
SELECT
   EACHUSER.GETRESPDESC(oTxDate,oStan) RESP
  -- , a.*
  ,OTXDATE, OSTAN, PCODE, CLEARINGCODE, OBIZDATE, OCLEARINGPHASE, BIZDATE, CLEARINGPHASE, RESULTCODE, SENDERBANK, SENDERCLEARING, INCLEARING, OUTCLEARING, SENDERACQUIRE, INACQUIRE, OUTACQUIRE, SENDERHEAD, INHEAD, OUTHEAD, SENDERFEE, INFEE, OUTFEE, EACHFEE, TXAMT, SENDERBANKID, OUTBANKID, INBANKID, OUTACCT, INACCT, ACHFLAG, TXOBIZDATE, TXOCLEARINGPHASE,	TXBIZDATE,	TXCLEARINGPHASE, CURRENT TIMESTAMP, TXDT, SENDERID, TXID ,FLBIZDATE, FLPROCSEQ, FLBATCHSEQ,DATASEQ
FROM
	EACHUSER.ONPENDINGTAB a Where   OBIZDATE =sPREVDATE
;
commit;
END IF ;
-- 未完成交易結果資料 END
  
    CALL EACHUSER.UPD_EACH_BATCH_STATUS(sBizDATE, sPhase ,'BAT_RPONPENDINGTAB', 'S');
END
GO







